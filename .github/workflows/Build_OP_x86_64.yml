name: Build_x86_64

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 5"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DEBIAN_FRONTEND: noninteractive
      REPO_URL: https://github.com/coolsnowwolf/lede
      REPO_BRANCH: master
      CONFIG_FILE: "x86_64.config"
      GITHUB_TOKEN: ${{ github.token }}

    steps:
    # ------------------------------
    # Checkout Repo
    # ------------------------------
    - name: Checkout
      uses: actions/checkout@master

    # ------------------------------
    # Build Dependencies (最精简且完整)
    # ------------------------------
    - name: Initialization environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential gawk gettext cmake \
          flex bison autoconf automake libtool \
          libncurses5-dev zlib1g-dev libssl-dev libelf-dev \
          python3 python3-pyelftools \
          gcc-multilib g++-multilib \
          git-core subversion wget curl rsync unzip \
          p7zip-full upx-ucl

    # ------------------------------
    # Host Info
    # ------------------------------
    - name: Echo host info
      run: |
        echo "CPU: $(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2-)"
        echo "Cores: $(nproc)"
        echo "Memory:"
        free -h

    # ------------------------------
    # Clone OpenWrt
    # ------------------------------
    - name: Clone source code
      run: |
        echo "DEV_NAME=_$(basename "$CONFIG_FILE" .config)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        sudo mv openwrt /mnt/ && sudo ln -s /mnt/openwrt ./ && sudo chown -R $USER:$GROUPS /mnt/openwrt

        cd openwrt
        sed -i '1i src-git kenzo https://github.com/kenzok8/openwrt-packages' feeds.conf.default
        sed -i '2i src-git small https://github.com/kenzok8/small' feeds.conf.default

    # ------------------------------
    # Cache dl/
    # ------------------------------
    - name: Cache OpenWrt dl
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    # ------------------------------
    # Cache ccache
    # ------------------------------
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles(env.CONFIG_FILE) }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    # ------------------------------
    # Update Feeds + Use Latest Golang (Fix Xray/SingBox)
    # ------------------------------
    - name: Update feeds and install new golang
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a

        # 移除会导致冲突的 feed
        rm -rf feeds/luci/applications/luci-app-mosdns
        rm -rf feeds/packages/net/{alist,adguardhome,mosdns,xray*,v2ray*,sing*,smartdns}
        rm -rf feeds/packages/utils/v2dat

        ./scripts/feeds install -a

        # 使用 OpenWrt 官方最新 golang（go1.25）
        rm -rf feeds/packages/lang/golang
        svn export https://github.com/openwrt/packages/trunk/lang/golang feeds/packages/lang/golang

        ./scripts/feeds install golang
        make package/feeds/packages/golang/compile -j"$(nproc)" V=s

    # ------------------------------
    # 查看 gcc / go 版本
    # ------------------------------
    - name: Check Go version in toolchain
      working-directory: ./openwrt
      run: |
        find staging_dir -path '*bin/go' | xargs -r -I{} sh -c '{} version || true'

    # ------------------------------
    # Load Config & Customize
    # ------------------------------
    - name: Configuration Customization
      run: |
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x ./customize.sh || true
        ./customize.sh || true
        cd openwrt && make defconfig

    # ------------------------------
    # Download Dependencies
    # ------------------------------
    - name: Download package
      working-directory: ./openwrt
      run: |
        make download -j$(nproc)
        find dl -size -1024c -exec rm -f {} \;

    # ------------------------------
    # Build with Live Error Output
    # ------------------------------
    - name: Build firmware (with live error highlight)
      working-directory: ./openwrt
      run: |
        make -j$(nproc) V=s 2>&1 | tee build.log | \
          grep --line-buffered -i -E "error:|failed|cannot|undefined|not found|missing|requires go|dependency|panic" &
        wait $!
        cp .config bin/

    # ------------------------------
    # Upload Firmware
    # ------------------------------
    - name: Upload artifact
      uses: actions/upload-artifact@master
      with:
        name: OpenWrt_bin${{ env.DEV_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    # ------------------------------
    # Build VMDK for ESXi
    # ------------------------------
    - name: Build VMDK
      run: |
        sudo apt-get install -y qemu-utils
        cd ./openwrt/bin/targets/x86/64
        gunzip -f openwrt-x86-64-generic-squashfs-combined-efi.img.gz || true

        qemu-img convert -f raw -O vmdk \
          -o subformat=monolithicFlat \
          openwrt-x86-64-generic-squashfs-combined-efi.img \
          openwrt.vmdk

        tar -czf openwrt_vmdk.tar.gz openwrt.vmdk openwrt-flat.vmdk

    - name: Upload VMDK
      uses: actions/upload-artifact@master
      with:
        name: openwrt-vmdk${{ env.FILE_DATE }}
        path: ./openwrt/bin/targets/x86/64/openwrt_vmdk.tar.gz

    # ------------------------------
    # Cleanup Old Workflow Runs
    # ------------------------------
    - name: 删除运行记录
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
